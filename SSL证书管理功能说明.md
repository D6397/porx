# SSL证书管理功能说明

## 功能概述

本系统将SSL证书管理直接集成到代理服务器配置中，实现了证书的可视化管理和自动化部署。无需单独的证书管理界面，直接在服务器管理页面即可完成所有SSL相关操作。

## 🔐 核心特性

### 一体化管理
- SSL证书管理直接嵌入到代理服务器配置中
- 每个服务器可以独立管理自己的SSL证书
- 无需复杂的关联配置和映射关系

### 多格式支持
- **证书文件**: .pem, .crt, .cer
- **私钥文件**: .key, .pem, .txt
- 自动文件类型验证和大小限制（10MB）

### 可视化操作
- 拖拽式文件上传界面
- 实时上传进度显示
- 证书状态一目了然

## 📁 文件存储结构

```
ssl/
├── certs/          # 证书文件存储目录
│   ├── cert-1-1701234567890.pem
│   └── cert-2-1701234567891.crt
└── keys/           # 私钥文件存储目录
    ├── key-1-1701234567890.key
    └── key-2-1701234567891.pem
```

### 文件命名规则
- 格式: `{type}-{serverId}-{timestamp}{extension}`
- 示例: `cert-1-1701234567890.pem`
- 自动避免文件名冲突

## 🎯 使用流程

### 1. 上传SSL证书

1. **进入服务器管理页面**
   - 确保目标服务器处于停止状态

2. **打开SSL上传对话框**
   - 点击服务器操作列中的"SSL"下拉按钮
   - 选择"上传证书"选项

3. **选择证书文件**
   - 证书文件：点击"选择证书文件"按钮
   - 私钥文件：点击"选择私钥文件"按钮
   - 支持单独上传或同时上传

4. **确认上传**
   - 点击"上传"按钮开始上传
   - 等待上传完成提示

### 2. 查看SSL状态

在服务器列表的"SSL状态"列中可以看到：
- **SSL启用状态**: 显示为"启用"或"禁用"
- **证书上传状态**: 显示"已上传"标签（如果有证书）
- **详细信息**: 鼠标悬停查看证书文件名和上传时间

### 3. 删除SSL证书

1. **停止服务器**（如果正在运行）
2. **打开SSL菜单**
3. **选择删除证书**
4. **确认删除操作**

## 🛡️ 安全机制

### 运行时保护
- 运行中的服务器禁止SSL操作
- 确保服务器运行时证书文件不被意外修改

### 文件验证
- 严格的文件类型检查
- 文件大小限制（10MB）
- 防止恶意文件上传

### 权限控制
- 只有管理员可以操作SSL证书
- JWT认证保护所有API接口

### 自动清理
- 删除服务器时自动清理相关证书文件
- 上传新文件时自动覆盖旧文件
- 防止磁盘空间浪费

## 🔧 技术实现

### 后端技术
- **文件上传**: Multer中间件处理多文件上传
- **文件存储**: 基于磁盘的文件系统存储
- **数据库集成**: SSL信息直接存储在proxy_servers表中
- **API设计**: RESTful API接口

### 前端技术
- **上传组件**: Element Plus Upload组件
- **文件选择**: 支持拖拽和点击选择
- **状态显示**: 实时状态更新和工具提示
- **错误处理**: 友好的错误信息提示

### 数据库字段
```sql
-- proxy_servers表新增字段
cert_file_name varchar(255)     -- SSL证书文件名
key_file_name varchar(255)      -- SSL私钥文件名  
cert_path varchar(500)          -- SSL证书文件路径
key_path varchar(500)           -- SSL私钥文件路径
cert_expire_date datetime       -- SSL证书过期时间
cert_uploaded_at timestamp      -- SSL证书上传时间
```

## 📊 API接口

### 上传SSL证书
```http
POST /api/proxy/servers/:id/ssl-upload
Content-Type: multipart/form-data

文件字段:
- cert: SSL证书文件 (可选)
- key: SSL私钥文件 (可选)
```

### 删除SSL证书
```http
DELETE /api/proxy/servers/:id/ssl
```

### 获取服务器信息（含SSL）
```http
GET /api/proxy/servers
```

## ⚠️ 注意事项

### 操作限制
- 服务器运行时无法进行SSL操作
- 必须先停止服务器才能上传或删除证书
- 证书文件大小不能超过10MB

### 文件格式
- 确保证书文件格式正确
- 私钥文件必须与证书文件匹配
- 不支持加密的私钥文件

### 存储要求
- 确保ssl目录有足够的磁盘空间
- ssl目录需要有写入权限
- 建议定期备份证书文件

## 🔄 升级说明

### 从v1.1.x升级到v1.2.0
1. **停止服务器**
2. **运行数据库升级脚本**:
   ```bash
   mysql -h localhost -u proxy -p proxy < scripts/upgrade-ssl-integration.sql
   ```
3. **重启服务器**
4. **开始使用SSL功能**

### 数据迁移
如果之前使用独立的ssl_certificates表，升级后数据不会自动迁移。需要：
1. 手动重新上传证书文件
2. 或编写迁移脚本转移数据

## 📈 后续规划

### v1.3.0计划功能
- SSL证书到期监控和提醒
- Let's Encrypt自动证书申请
- 证书链验证和健康检查
- 证书自动续期功能

### 长期规划
- 证书模板和批量部署
- 证书性能监控
- 多种CA支持
- 证书备份和恢复

---

**更新时间**: 2024年12月  
**适用版本**: v1.2.0+ 