# 系统日志功能说明

## 功能概述

隧道代理管理系统现已完整实现系统日志功能，包括：

✅ **后端日志系统**
- 应用日志 (app.log)
- 错误日志 (error.log) 
- 访问日志 (access.log)
- 连接日志 (数据库存储)

✅ **前端日志管理界面**
- 实时日志查看
- 日志筛选和搜索
- 日志统计图表
- 日志导出功能
- 日志清理功能

✅ **API接口**
- 系统日志查询
- 连接日志查询
- 日志统计分析
- 日志文件管理

## 功能特性

### 🔍 日志查看
- **多类型日志**: 连接日志、系统日志、错误日志、访问日志
- **实时刷新**: 支持手动刷新和定时更新
- **智能筛选**: 按日志类型、级别、时间范围筛选
- **分页显示**: 支持大量日志数据的分页浏览

### 📊 日志统计
- **今日统计**: 总日志数、连接数、成功认证、错误数
- **时间分析**: 小时级别和每日趋势分析
- **热门目标**: 最常访问的目标主机统计
- **用户活动**: 用户连接活动分析

### 📥 日志管理
- **导出功能**: 支持CSV格式导出
- **清理功能**: 自动清理过期日志
- **下载功能**: 支持日志文件直接下载
- **存储管理**: 日志文件大小和存储监控

### 🔒 安全特性
- **访问控制**: 需要管理员认证才能查看日志
- **敏感信息**: 自动隐藏敏感数据
- **审计追踪**: 记录所有系统操作
- **权限管理**: 基于JWT的访问控制

## 日志格式

### 应用日志 (app.log)
```json
{
  "timestamp": "2025-06-26T18:10:59.420Z",
  "level": "info",
  "message": "隧道代理后台管理系统启动成功",
  "port": "3000",
  "environment": "development",
  "nodeVersion": "v22.15.1",
  "platform": "darwin"
}
```

### 错误日志 (error.log)
```json
{
  "timestamp": "2025-06-26T18:10:59.426Z",
  "level": "error",
  "message": "数据库连接失败",
  "stack": "Error stack trace...",
  "url": "/api/users",
  "method": "GET",
  "ip": "127.0.0.1"
}
```

### 访问日志 (access.log)
```json
{
  "timestamp": "2025-06-26T18:01:34.910Z",
  "level": "info",
  "message": "GET /api/health",
  "ip": "::1",
  "userAgent": "Mozilla/5.0...",
  "statusCode": 200,
  "duration": "2ms",
  "contentLength": 156
}
```

## API接口

### 系统日志查询
```http
GET /api/logs/system?type=app&lines=100&level=info
Authorization: Bearer <token>
```

### 连接日志查询
```http
GET /api/proxy/logs?page=1&limit=20
Authorization: Bearer <token>
```

### 日志统计
```http
GET /api/proxy/logs/stats
Authorization: Bearer <token>
```

### 日志导出
```http
GET /api/proxy/logs/export?format=csv
Authorization: Bearer <token>
```

### 日志清理
```http
POST /api/proxy/logs/cleanup
Content-Type: application/json
Authorization: Bearer <token>

{
  "days": 30
}
```

## 使用指南

### 1. 访问日志界面
1. 登录管理后台: http://localhost:3000
2. 点击左侧菜单的"📋 日志查看"
3. 选择需要查看的日志类型

### 2. 日志筛选
- **日志类型**: 选择连接日志、系统日志、错误日志或访问日志
- **日志级别**: 筛选info、warn、error级别的日志
- **显示条数**: 设置每页显示的日志条数

### 3. 日志操作
- **刷新**: 点击"刷新"按钮获取最新日志
- **导出**: 点击"导出"按钮下载CSV格式日志
- **清理**: 点击"清理"按钮删除过期日志

### 4. 日志分析
- 查看日志统计卡片了解系统状态
- 分析连接趋势和用户活动
- 监控错误日志发现问题

## 配置说明

### 环境变量
```bash
# 日志配置
PROXY_ENABLE_LOGS=true          # 启用日志记录
PROXY_DETAILED_LOGS=true        # 启用详细日志
PROXY_LOG_LEVEL=info            # 日志级别
```

### 日志文件位置
```
logs/
├── app.log      # 应用运行日志
├── error.log    # 错误日志
└── access.log   # HTTP访问日志
```

### 数据库表
```sql
connection_logs  # 连接日志表
├── id
├── username
├── client_ip
├── target_host
├── action
├── session_id
└── created_at
```

## 性能优化

### 日志轮转
- 系统会自动管理日志文件大小
- 支持按时间清理过期日志
- 可配置日志保留策略

### 存储优化
- JSON格式结构化存储
- 支持压缩和归档
- 数据库索引优化查询

### 查询优化
- 分页查询减少内存占用
- 索引加速日志检索
- 缓存常用统计数据

## 注意事项

1. **权限要求**: 只有管理员用户可以查看系统日志
2. **存储空间**: 定期清理日志文件防止磁盘空间不足
3. **性能影响**: 详细日志可能影响系统性能，生产环境建议适当调整
4. **敏感信息**: 系统会自动过滤密码等敏感信息
5. **备份建议**: 重要日志数据建议定期备份

## 故障排除

### 常见问题

**Q: 日志文件不生成？**
A: 检查logs目录权限，确保应用有写入权限

**Q: 日志查看界面显示空白？**
A: 检查JWT认证token是否有效，尝试重新登录

**Q: 导出功能不工作？**
A: 检查浏览器是否阻止下载，确认文件权限

**Q: 日志占用空间过大？**
A: 定期使用清理功能或手动删除过期日志文件

---

🎉 **恭喜！系统日志功能已完全实现！**

现在您可以：
- 实时监控系统运行状态
- 分析用户连接行为
- 快速定位系统问题
- 导出日志数据进行分析
- 管理日志存储空间

访问 http://localhost:3000 开始使用完整的日志管理功能！ 