# 文件上传安全修复说明

## 🔒 已修复的安全问题

### 1. **路径遍历攻击防护**
- ✅ **问题**：原始代码没有充分验证文件路径，存在路径遍历风险
- ✅ **修复**：
  - 使用 `path.resolve()` 和 `validatePath()` 函数确保文件只能保存在指定目录内
  - 严格验证文件名，禁止包含 `..`、`/`、`\` 等路径字符
  - 使用 `path.basename()` 清理文件名

### 2. **文件内容验证**
- ✅ **问题**：只检查文件扩展名，不验证实际内容
- ✅ **修复**：
  - 增加 `validateFileContent()` 函数检查文件内容格式
  - 验证SSL证书必须包含 `-----BEGIN CERTIFICATE-----`
  - 验证私钥必须包含 `-----BEGIN PRIVATE KEY-----` 等标识
  - 检查文件内容大小限制

### 3. **安全的文件名生成**
- ✅ **问题**：文件名可能冲突或包含危险字符
- ✅ **修复**：
  - 使用 `crypto.randomBytes()` 生成安全随机文件名
  - 清理文件扩展名，只保留安全字符
  - 添加时间戳和服务器ID防止冲突

### 4. **严格的输入验证**
- ✅ **问题**：服务器ID等参数验证不够严格
- ✅ **修复**：
  - `validateServerId()` 严格验证服务器ID格式和范围
  - `validateFilename()` 检查文件名长度、危险字符、保留名称
  - `validateFileExtension()` 白名单验证文件扩展名

### 5. **文件大小和数量限制**
- ✅ **问题**：可能被绕过的大小限制
- ✅ **修复**：
  - Multer配置严格的文件大小限制（10MB）
  - 限制同时上传文件数量（最多2个）
  - 限制表单字段和部分数量

### 6. **安全的文件删除**
- ✅ **问题**：删除文件时可能泄露路径信息
- ✅ **修复**：
  - `safeDeleteFile()` 函数验证删除路径安全性
  - 优雅处理文件不存在的情况
  - 避免错误信息泄露敏感路径

### 7. **临时文件清理**
- ✅ **问题**：上传失败时可能留下临时文件
- ✅ **修复**：
  - `cleanupTempFiles()` 函数自动清理上传失败的文件
  - 在所有错误处理分支中调用清理函数
  - 防止磁盘空间浪费和信息泄露

### 8. **错误信息安全**
- ✅ **问题**：错误信息可能泄露系统敏感信息
- ✅ **修复**：
  - 标准化错误响应，不泄露内部路径
  - 区分客户端错误和服务器错误
  - 敏感操作的详细日志记录

## 🛡️ 新增安全配置

### 集中化安全配置 (`server/config/security.js`)
```javascript
// 文件上传安全配置
const FILE_UPLOAD_CONFIG = {
  ssl: {
    maxFileSize: 10 * 1024 * 1024, // 10MB
    maxFiles: 2,
    allowedExtensions: ['.pem', '.crt', '.cer', '.key', '.txt'],
    allowedMimeTypes: [...],
    uploadDir: path.resolve(__dirname, '../../ssl')
  }
};
```

### 安全函数库
- `validatePath()` - 路径遍历防护
- `validateFilename()` - 文件名安全验证
- `validateFileExtension()` - 扩展名白名单验证
- `validateFileContent()` - 文件内容格式验证
- `validateServerId()` - 服务器ID验证
- `generateSecureFilename()` - 安全文件名生成
- `safeDeleteFile()` - 安全文件删除

## 🚀 测试建议

### 前端测试要点
1. **正常上传测试**：
   - 上传有效的SSL证书文件
   - 上传有效的私钥文件
   - 同时上传证书和私钥

2. **安全攻击测试**：
   - 尝试上传包含路径遍历的文件名（如 `../../../etc/passwd`）
   - 上传非SSL格式的文件（如 `.exe`、`.php`）
   - 上传超大文件（>10MB）
   - 上传包含恶意内容的文件

3. **边界条件测试**：
   - 上传空文件
   - 上传只包含证书或只包含私钥
   - 文件名包含特殊字符
   - 同时上传多个文件

4. **权限测试**：
   - 在服务器运行时尝试上传SSL证书
   - 删除不存在的SSL证书
   - 使用无效的服务器ID

## 📋 验证清单

- [ ] 无法通过文件名进行路径遍历攻击
- [ ] 只能上传有效的SSL证书格式文件
- [ ] 文件大小限制生效（10MB）
- [ ] 上传失败时临时文件被清理
- [ ] 错误信息不泄露敏感路径
- [ ] 服务器运行时无法上传SSL证书
- [ ] 删除操作安全且优雅
- [ ] 文件名生成唯一且安全

## 🔧 监控建议

建议在生产环境中监控以下指标：
- SSL证书上传失败率
- 文件上传错误类型统计
- 磁盘空间使用情况
- 安全警告日志（可疑MIME类型等）

---

**注意**：所有修复都向后兼容，不会影响现有功能的正常使用。 